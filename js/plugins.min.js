function clearImage(){ctx.clearRect(0,0,inMemCanvas.width,inMemCanvas.height),userPhoto.style.display="none"}function moveElement(e){switch(clearImage(),e){case"top":b-=5;break;case"bottom":b+=5;break;case"left":a-=5;break;case"right":a+=5}ctx.drawImage(currentPhoto,a,b,inMemCanvas.width*currentScale,inMemCanvas.height*currentScale)}function moveElementTop(e){moveElement("top")}function moveElementLeft(e){moveElement("left")}function moveElementRight(e){moveElement("right")}function moveElementBottom(e){moveElement("bottom")}function zoomInElement(e){clearImage(),currentScale-=.1,userPhoto.style.display="none",ctx.drawImage(currentPhoto,a,b,inMemCanvas.width*currentScale,inMemCanvas.height*currentScale)}function zoomOutElement(e){clearImage(),currentScale+=.1,userPhoto.style.display="none",ctx.drawImage(currentPhoto,a,b,inMemCanvas.width*currentScale,inMemCanvas.height*currentScale)}function grayScale(e){e.stopPropagation();var t=ctx.getImageData(x,y,userPhoto.width,userPhoto.height),n=t.data;ctx.restore();for(var o=0;o<n.length;o+=4){var i=.3*n[o]+.6*n[o+1]+.1*n[o+2];n[o]=i,n[o+1]=i,n[o+2]=i}ctx.putImageData(t,x,y,x,y,userPhoto.width,userPhoto.height),ctx.save()}function brightenImage(e){var t,n=ctx.getImageData(x,y,userPhoto.width,userPhoto.height),o=n.data;void 0===brightenRangeSlider.oldValue&&(brightenRangeSlider.oldValue=brightenRangeSlider.defaultValue),t=brightenRangeSlider.value-brightenRangeSlider.oldValue,brightenRangeSlider.oldValue=brightenRangeSlider.value,ctx.restore();for(var i=0;i<o.length;i+=4)o[i]+=t,o[i+1]+=t,o[i+2]+=t;ctx.putImageData(n,x,y,x,y,userPhoto.width,userPhoto.height),ctx.save()}function negativeFilter(e){e.stopPropagation();var t=ctx.getImageData(x,y,canvas.width,canvas.height),n=t.data;if(ctx.restore(),"undefined"==typeof inverted||0==inverted){for(var o=0;o<n.length;o+=4)n[o]=255-n[o],n[o+1]=255-n[o+1],n[o+2]=255-n[o+2];ctx.putImageData(t,x,y,x,y,userPhoto.width,userPhoto.height),inverted=!0}ctx.save()}function setMarginLeft(){if(window.matchMedia("(min-width: 480px)").matches){var e=$("#leftBorder"),t=e.position().left;$("#tools-left").css({marginLeft:t})}}var togglePosition=document.getElementById("togglePosition"),toggleZoom=togglePosition.nextElementSibling,toolsNav=document.getElementById("toolsNav"),toggleGrayscale=toolsNav.firstElementChild.children[1],toggleBrightness=toggleGrayscale.nextElementSibling,toggleBlur=toggleBrightness.nextElementSibling,toggleNegative=toggleBlur.nextElementSibling,toggleEdgeDetect=toggleNegative.nextElementSibling,toggleSharpen=toggleEdgeDetect.nextElementSibling,toggleEmboss=toggleSharpen.nextElementSibling,openFiltersNav=document.getElementById("openFiltersNav"),closeFiltersNav=toolsNav.firstElementChild.firstElementChild,controlsPosition=document.getElementsByClassName("controls-position")[0],controlsZoom=controlsPosition.nextElementSibling,grayScaleBtns=document.getElementById("grayScale"),grayScaleBtnsWrapper=grayScaleBtns.children[0],grayScaleOn=grayScaleBtnsWrapper.children[0],grayScaleOff=grayScaleOn.nextElementSibling,brightenDiv=document.getElementById("brighten-range"),blurDiv=document.getElementById("blur-range"),sharpenDiv=document.getElementById("sharpen-range"),negativeBtns=document.getElementsByClassName("scale-btns")[1],negativeOn=negativeBtns.children[0].children[0],negativeOff=negativeOn.nextElementSibling,edgeDetectBtns=document.getElementsByClassName("scale-btns")[2],edgeDetectOn=edgeDetectBtns.children[0].children[0],edgeDetectOff=edgeDetectOn.nextElementSibling,embossBtns=document.getElementsByClassName("scale-btns")[3],embossOn=embossBtns.children[0].children[0],embossOff=embossOn.nextElementSibling,sliderFilters=document.getElementsByClassName("slider-filter"),toolsInfo=document.getElementsByClassName("tools-info")[0],brightenRangeSlider=document.getElementById("brightenRange"),blurRangeSlider=document.getElementById("blurRange"),sharpenRangeSlider=document.getElementById("sharpenRange"),imgContainer=document.getElementById("imgContainer"),userPhoto=document.getElementById("userPhoto"),currentPhoto=new Image,inputFile=document.getElementById("inputFile"),uploadPhoto=document.getElementById("uploadPhoto"),canvas=document.getElementById("imgCanvas"),ctx=canvas.getContext("2d"),resetBtn=document.getElementById("resetBtn"),download=document.getElementById("download"),moveTop=document.getElementById("moveTop"),moveRight=document.getElementById("moveRight"),moveLeft=document.getElementById("moveLeft"),moveBottom=document.getElementById("moveBottom"),zoomIn=document.getElementById("zoom-in"),zoomOut=document.getElementById("zoom-out"),toolsLeftMoveTop=document.getElementById("toolsLeftMoveTop"),toolsLeftMoveLeft=document.getElementById("toolsLeftMoveLeft"),toolsLeftMoveRight=document.getElementById("toolsLeftMoveRight"),toolsLeftMoveBottom=document.getElementById("toolsLeftMoveBottom"),toolsLeftZoomIn=document.getElementById("toolsLeftZoomIn"),toolsLeftZoomOut=document.getElementById("toolsLeftZoomOut"),x,y;"undefined"==typeof x&&(x=0),"undefined"==typeof y&&(y=0);var inMemCanvas=document.createElement("canvas"),a=0,b=0,currentScale=1;inMemCanvas.width=210,inMemCanvas.height=250,moveTop.addEventListener("click",moveElementTop,!1),toolsLeftMoveTop.addEventListener("click",moveElementTop,!1),moveLeft.addEventListener("click",moveElementLeft,!1),toolsLeftMoveLeft.addEventListener("click",moveElementLeft,!1),moveRight.addEventListener("click",moveElementRight,!1),toolsLeftMoveRight.addEventListener("click",moveElementRight,!1),moveBottom.addEventListener("click",moveElementBottom,!1),toolsLeftMoveBottom.addEventListener("click",moveElementBottom,!1),zoomIn.addEventListener("click",zoomInElement,!1),toolsLeftZoomIn.addEventListener("click",zoomInElement,!1),zoomOut.addEventListener("click",zoomOutElement,!1),toolsLeftZoomOut.addEventListener("click",zoomOutElement,!1),grayScaleOn.addEventListener("click",grayScale,!1),grayScaleOff.addEventListener("click",function(e){ctx.clearRect(x,y,canvas.width,canvas.height),ctx.drawImage(currentPhoto,x,y)},!1);var inverted;Filters={},Filters.getPixels=function(e){var t=this.getCanvas(e.width,e.height),n=t.getContext("2d");return n.drawImage(e,0,0),n.getImageData(0,0,t.width,t.height)},Filters.getCanvas=function(e,t){var n=document.createElement("canvas");return n.width=e,n.height=t,n},Filters.filterImage=function(e,t,n){for(var o=[this.getPixels(t)],i=2;i<arguments.length;i++)o.push(arguments[i]);return e.apply(null,o)},Filters.grayscale=function(e,t){for(var n=e.data,o=0;o<n.length;o+=4){var i=n[o],a=n[o+1],l=n[o+2],r=.2126*i+.7152*a+.0722*l;n[o]=n[o+1]=n[o+2]=r}return e},Filters.brightness=function(e,t){for(var n=e.data,o=0;o<n.length;o+=4)n[o]+=t,n[o+1]+=t,n[o+2]+=t;return e},Filters.threshold=function(e,t){for(var n=e.data,o=0;o<n.length;o+=4){var i=n[o],a=n[o+1],l=n[o+2],r=.2126*i+.7152*a+.0722*l>=t?255:0;n[o]=n[o+1]=n[o+2]=r}return e},Filters.tmpCanvas=document.createElement("canvas"),Filters.tmpCtx=Filters.tmpCanvas.getContext("2d"),Filters.createImageData=function(e,t){return this.tmpCtx.createImageData(e,t)},Filters.convolute=function(e,t,n){for(var o=Math.round(Math.sqrt(t.length)),i=Math.floor(o/2),a=e.data,l=e.width,r=e.height,s=l,c=r,d=Filters.createImageData(s,c),g=d.data,m=n?1:0,h=0;h<c;h++)for(var v=0;v<s;v++){for(var u=h,f=v,y=4*(h*s+v),E=0,b=0,p=0,x=0,w=0;w<o;w++)for(var L=0;L<o;L++){var I=u+w-i,B=f+L-i;if(I>=0&&I<r&&B>=0&&B<l){var P=4*(I*l+B),S=t[w*o+L];E+=a[P]*S,b+=a[P+1]*S,p+=a[P+2]*S,x+=a[P+3]*S}}g[y]=E,g[y+1]=b,g[y+2]=p,g[y+3]=x+m*(255-x)}return d},Filters.convoluteFloat32=function(e,t,n){for(var o=Math.round(Math.sqrt(t.length)),i=Math.floor(o/2),a=e.data,l=e.width,r=e.height,s=l,c=r,d={width:s,height:c,data:new Float32Array(s*c*4)},g=d.data,m=n?1:0,h=0;h<c;h++)for(var v=0;v<s;v++){for(var u=h,f=v,y=4*(h*s+v),E=0,b=0,p=0,x=0,w=0;w<o;w++)for(var L=0;L<o;L++){var I=Math.min(r-1,Math.max(0,u+w-i)),B=Math.min(l-1,Math.max(0,f+L-i)),P=4*(I*l+B),S=t[w*o+L];E+=a[P]*S,b+=a[P+1]*S,p+=a[P+2]*S,x+=a[P+3]*S}g[y]=E,g[y+1]=b,g[y+2]=p,g[y+3]=x+m*(255-x)}return d},Filters.sobel=function(e){e=Filters.grayscale(e);for(var t=Filters.convoluteFloat32(e,[-1,-2,-1,0,0,0,1,2,1]),n=Filters.convoluteFloat32(e,[-1,0,1,-2,0,2,-1,0,1]),o=Filters.createImageData(t.width,t.height),i=0;i<o.data.length;i+=4){var a=Math.abs(t.data[i]);o.data[i]=a;var l=Math.abs(n.data[i]);o.data[i+1]=l,o.data[i+2]=(a+l)/4,o.data[i+3]=255}return o},Filters.blur=function(e,t){for(var n=[1/9,1/9,1/9,1/9,1/9,1/9,1/9,1/9,1/9],o=0;o<t;o++)e=Filters.convolute(e,n);return e},Filters.emboss=function(e){var t=[-2,-1,0,-1,1,1,0,1,2];return Filters.convolute(e,t)},Filters.sharpen=function(e,t){for(var n=[0,-1,0,-1,5,-1,0,-1,0],o=0;o<t;o++)e=Filters.convolute(e,n);return e},window.addEventListener("resize",setMarginLeft,!1),window.addEventListener("load",setMarginLeft,!0),function(){document.addEventListener("DOMContentLoaded",function(e){function t(){if(window.matchMedia("(min-width: 480px)").matches){var e=$("#openFiltersNav"),t=e.position().left;$("#toolsNav").css({left:t-16,top:"50px",position:"absolute",display:"block","overflow-y":"auto"})}}function n(){"undefined"==typeof m&&(m=!1),window.matchMedia("(min-width: 480px)").matches&&0==m?(toolsNav.style.visibility="visible",toolsNav.style.height="100%",m=!0):window.matchMedia("(min-width: 480px)").matches&&1==m&&(toolsNav.style.visibility="hidden",toolsNav.style.height="0",m=!1),window.matchMedia("(max-width: 479px)").matches?(toolsNav.style.visibility="visible",toolsNav.style.height="100%"):window.matchMedia("(max-width: 479px)").matches&&(toolsNav.style.visibility="hidden",toolsNav.style.height="0")}function o(e){e.preventDefault(),window.matchMedia("(max-width: 479px)").matches&&(toolsNav.style.height="0%")}function i(){controlsPosition.style.visibility="hidden",controlsZoom.style.visibility="hidden",toolsInfo.style.visibility="hidden",brightenDiv.style.visibility="hidden",sharpenDiv.style.visibility="hidden",grayScaleBtns.style.visibility="hidden",blurDiv.style.visibility="hidden",negativeBtns.style.visibility="hidden",edgeDetectBtns.style.visibility="hidden",embossBtns.style.visibility="hidden"}function a(e){h.matches?e.target.removeEventListener("click",a):(i(),controlsPosition.style.visibility="visible"),g()}function l(e){h.matches?e.target.removeEventListener("click",l):(i(),controlsZoom.style.visibility="visible"),g()}function r(e){if(e.files&&e.files[0]){var t=new FileReader;t.onload=function(e){clearImage();var t=new Image;t.src=e.target.result;var n=210,o=250,i=t.width,a=t.height,l=0,r=0,s=0;s=i>a?a/i*100:i/a*100,s=Math.round(s)/100,i>=a?i>n&&(i=n,a=i*s,r=(o-a)/2):a>o&&(a=o,i=a*s,l=(n-i)/2),canvas.width=n,canvas.height=o,ctx.fillRect(0,0,canvas.width,canvas.height),ctx.drawImage(t,l,r,i,a);var c=canvas.toDataURL("image/png");userPhoto.setAttribute("src",c),g()},t.readAsDataURL(e.files[0])}}function s(e,t,n){e.href=canvas.toDataURL(),e.download=n}function c(e){ctx.beginPath(),ctx.lineWidth=e,canvas.width+=2*e,canvas.height+=2*e,ctx.fillStyle="#fff",ctx.strokeStyle="#fff",ctx.rect(0,0,canvas.width,30),ctx.fillRect(0,0,canvas.width,canvas.height),ctx.fill(),ctx.drawImage(currentPhoto,e,e,canvas.width-2*e,canvas.height-2*e-50)}function d(e){e&&"undefined"!=typeof FileReader?r(e):console.log("drag error")}function g(){ctx.save(),currentPhoto.src=canvas.toDataURL("image/png")}window.addEventListener("resize",t,!1),window.addEventListener("load",t,!0);var m;openFiltersNav.addEventListener("click",n,!1),closeFiltersNav.addEventListener("click",o,!1);var h=window.matchMedia("(min-width: 571px)");h.matches&&($("#togglePosition").attr("disabled",!0),$("#toggleZoom").attr("disabled",!0),$("#togglePosition").css({cursor:"auto"}),$("#toggleZoom").css({cursor:"auto"}),toolsInfo.innerHTML="choose your tool in the left-hand panel"),togglePosition.addEventListener("click",a,!1),toggleZoom.addEventListener("click",l,!1),toggleGrayscale.addEventListener("click",function(e){o(e),i(),grayScaleBtns.style.visibility="visible",g()},!1),toggleBrightness.addEventListener("click",function(e){o(e),i(),brightenDiv.style.visibility="visible",g()},!1),toggleBlur.addEventListener("click",function(e){o(e),i(),blurDiv.style.visibility="visible",g()},!1),toggleNegative.addEventListener("click",function(e){o(e),i(),negativeBtns.style.visibility="visible",g()},!1),toggleEdgeDetect.addEventListener("click",function(e){o(e),i(),edgeDetectBtns.style.visibility="visible",g()},!1),toggleSharpen.addEventListener("click",function(e){o(e),i(),sharpenDiv.style.visibility="visible",g()},!1),toggleEmboss.addEventListener("click",function(e){o(e),i(),embossBtns.style.visibility="visible",g()},!1),$("#scroll").on("click",function(e){return e.preventDefault(),window.matchMedia("(max-width: 700px)").matches?$("html, body").animate({scrollTop:$("#about").offset().top},"slow"):$("html, body").animate({scrollTop:411},"slow"),!1}),$("#about a").on("click",function(e){return e.preventDefault(),$("html, body").animate({scrollTop:$(document).height()},1200),!1}),$("#toTop").on("click",function(e){return $("body").animate({scrollTop:0},"slow"),!1}),$(document).on("scroll",function(e){$("body").scrollTop()>411}),$("#about").find("div").children().eq(1).on("click",function(e){return e.preventDefault(),$("html, body").animate({scrollTop:$("#interlude").offset().top},"slow"),!1}),$("#interlude").find("p").on("click",function(e){return e.preventDefault(),$("html, body").animate({scrollTop:$("#generator").offset().top},"slow"),!1}),canvas.width=210,canvas.height=250,$("#inputFile").change(function(e){r(this),$("#resetBtn").next().hide()}),uploadPhoto.addEventListener("click",function(e){$("#inputFile").trigger("click")},!1),brightenRangeSlider.addEventListener("input",brightenImage,!1),blurRangeSlider.addEventListener("input",function(e){var t=blurRangeSlider.value,n=Filters.filterImage(Filters.blur,currentPhoto,t);ctx.putImageData(n,x,y,x,y,currentPhoto.width,currentPhoto.height)},!1),negativeOn.addEventListener("click",negativeFilter,!1),negativeOff.addEventListener("click",function(e){ctx.clearRect(x,y,canvas.width,canvas.height),ctx.drawImage(currentPhoto,x,y),inverted=!1},!1),edgeDetectOn.addEventListener("click",function(e){var t=Filters.filterImage(Filters.sobel,currentPhoto);ctx.putImageData(t,x,y,x,y,currentPhoto.width,currentPhoto.height)},!1),edgeDetectOff.addEventListener("click",function(e){ctx.clearRect(x,y,canvas.width,canvas.height),ctx.drawImage(currentPhoto,x,y)},!1),sharpenRangeSlider.addEventListener("input",function(e){var t=sharpenRangeSlider.value,n=Filters.filterImage(Filters.sharpen,currentPhoto,t);ctx.putImageData(n,x,y,x,y,currentPhoto.width,currentPhoto.height)},!1),embossOn.addEventListener("click",function(e){var t=Filters.filterImage(Filters.emboss,currentPhoto);ctx.putImageData(t,x,y,x,y,currentPhoto.width,currentPhoto.height)},!1),embossOff.addEventListener("click",function(e){ctx.clearRect(x,y,canvas.width,canvas.height),ctx.drawImage(currentPhoto,x,y)},!1),resetBtn.addEventListener("click",function(e){ctx.save(),ctx.clearRect(x-1,y-1,canvas.width+2,canvas.height+2),ctx.restore(),ctx.drawImage(userPhoto,0,0,canvas.width,canvas.height),g()},!1),download.addEventListener("click",function(e){g(),c(20),s(this,"imgCanvas","impossible-photo.png"),canvas.style.display="none",location.reload()},!1);var v=document.createElement("audio");v.setAttribute("src","sounds/camera.mp3"),v.setAttribute("autoplay:false","autoplay"),v.load(),$.get(),download.addEventListener("click",function(e){v.play(),console.log("ok")},!1);var u=$("#imgContainer");u.on("dragover",function(){return u.addClass("hover"),!1}),u.on("dragleave",function(e){return u.removeClass("hover"),!1}),u.on("drop",function(e){e.stopPropagation(),e.preventDefault(),u.removeClass("hover"),$("#resetBtn").next().hide();var t=e.originalEvent.dataTransfer;return d(t),!1})})}();